<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register New Student</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <div class="app-header mb-3">
            <div class="brand">
                <div class="logo">FA</div>
                <div>
                    <h1>Register New Student</h1>
                    <p class="small-muted">Capture a clear photo for accurate recognition</p>
                </div>
            </div>
            <div>
                <a class="btn secondary" href="{{ url_for('admin.admin_dashboard') }}">Back to Dashboard</a>
                <button id="settingsButton" class="btn secondary" type="button">âš™ Settings</button>
                <button id="muteButton" class="btn secondary" type="button">ðŸ”Š <span id="muteLabel">Mute</span></button>
            </div>
        </div>

        <div class="form-container">
            <form id="registerForm">
                <div class="form-group">
                    <label for="student_id">Student ID:</label>
                    <input type="text" id="student_id" name="student_id" required>
                </div>
                <div class="form-group">
                    <label for="name">Full Name:</label>
                    <input type="text" id="name" name="name" required>
                </div>

                <div style="position:relative;max-width:480px;margin:14px auto;text-align:center">
                    <video id="videoElement" autoplay playsinline></video>
                    <div class="guide-box" style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:240px;height:300px;border-radius:10px;"></div>
                </div>

                <div class="small-muted" style="text-align:center;margin-bottom:8px">Please position your face within the box. Good lighting and a centered face help recognition.</div>

                <div id="faceStatus" style="text-align:center;margin-bottom:12px;display:block"></div>
                <canvas id="capturedPhoto" style="display:none"></canvas>

                <div style="text-align:center;margin-bottom:8px">
                    <button type="button" id="captureBtn" class="btn">Capture Photo</button>
                    <button type="button" id="retakeBtn" class="btn" style="display:none;margin-left:10px">Retake Photo</button>
                </div>

                <div style="text-align:center">
                    <button type="submit" id="submitBtn" disabled class="btn">Register</button>
                </div>

                <div id="message" style="text-align:center;margin-top:12px"></div>
            </form>
        </div>
        </div>

            <!-- Settings modal -->
        <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="settingsModalLabel">Settings</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Recognition cooldown (ms)</label>
                            <input id="setting_recognition_cooldown" type="number" class="form-control" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Sound cooldown (ms)</label>
                            <input id="setting_sound_cooldown" type="number" class="form-control" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Min consecutive frames (local hint)</label>
                            <input id="setting_min_consecutive" type="number" class="form-control" />
                        </div>
                        <div class="small-muted">These settings are stored locally in your browser and override client-side behavior only. Server keeps canonical settings.</div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn" onclick="saveSettingsFromModal()">Save</button>
                    </div>
                </div>
            </div>
        </div>

    <script>
        // Registration page scoped JS (namespaced to avoid colliding with shared script.js)
        (function(){
        let video = null;
        let stream = null;
        let photoTaken = false;
        let faceDetectionInterval = null;
        const faceStatusElement = document.getElementById('faceStatus');

    // Initialize the camera feed
    async function regInitCamera() {
            try {
                video = document.getElementById('videoElement');
                if (!video) {
                    throw new Error('Video element not found');
                }

                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: "user"
                    }
                });
                
                video.srcObject = stream;
                
                // Wait for video to be ready
                await new Promise((resolve, reject) => {
                    video.onloadedmetadata = () => {
                        video.play()
                            .then(resolve)
                            .catch(reject);
                    };
                    video.onerror = () => reject(new Error('Video element error'));
                });

                // Start periodic face detection
                faceDetectionInterval = setInterval(checkFaceDetection, 1000);

                console.log('Camera initialized successfully');
            } catch (err) {
                console.error('Error accessing camera:', err);
                faceStatusElement.textContent = 'Error accessing camera: ' + err.message;
                faceStatusElement.className = 'status-bad';
                faceStatusElement.style.display = 'block';
            }
        }

        // Periodically check for face in the video feed (uses a single, consistent method)
        async function checkFaceDetection() {
            const video = document.getElementById('videoElement');
            if (!video || !video.srcObject || video.paused || video.ended || photoTaken) return;

            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0);

            const photoData = canvas.toDataURL('image/jpeg');

            try {
                const response = await fetch('/api/check-face', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ photo: photoData })
                });

                const result = await response.json();
                if (result.face_detected) {
                    faceStatusElement.textContent = 'âœ“ Face detected - Good position for registration';
                    faceStatusElement.className = 'status-good';
                    document.getElementById('captureBtn').disabled = false;
                } else {
                    faceStatusElement.textContent = 'âš  No face detected - Please adjust your position';
                    faceStatusElement.className = 'status-bad';
                    document.getElementById('captureBtn').disabled = true;
                }
                faceStatusElement.style.display = 'block';
            } catch (error) {
                console.error('Error checking face:', error);
            }
        }

    // Start camera when page loads
    document.addEventListener('DOMContentLoaded', regInitCamera);

        // Capture photo
        document.getElementById('captureBtn').addEventListener('click', function() {
            const canvas = document.getElementById('capturedPhoto');
            const context = canvas.getContext('2d');
            
            // Set canvas size to match video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Draw video frame to canvas
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Show canvas and retake button, hide video and capture button
            canvas.style.display = 'block';
            video.style.display = 'none';
            this.style.display = 'none';
            document.getElementById('retakeBtn').style.display = 'inline-block';
            document.getElementById('submitBtn').disabled = false;
            
            photoTaken = true;
        });

        // Retake photo
        document.getElementById('retakeBtn').addEventListener('click', function() {
            // Show video and capture button, hide canvas and retake button
            document.getElementById('videoElement').style.display = 'block';
            document.getElementById('capturedPhoto').style.display = 'none';
            document.getElementById('captureBtn').style.display = 'inline-block';
            this.style.display = 'none';
            document.getElementById('submitBtn').disabled = true;
            
            photoTaken = false;
        });

        // Show message
        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = message;
            messageDiv.className = type;
        }

        // Handle form submission
        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!photoTaken) {
                showMessage('Please capture a photo first', 'error');
                return;
            }

            try {
                // Get form data
                const studentId = document.getElementById('student_id').value;
                const name = document.getElementById('name').value;
                
                // Get photo data
                const canvas = document.getElementById('capturedPhoto');
                const photoData = canvas.toDataURL('image/jpeg');
                
                // Send data to server
                const response = await fetch('{{ url_for("admin.register_student") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        student_id: studentId,
                        name: name,
                        photo: photoData
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage('Student registered successfully!', 'success');
                    // Reset form
                    this.reset();
                    // Reset camera view
                    document.getElementById('retakeBtn').click();
                } else {
                    showMessage(data.message || 'Registration failed. Please try again.', 'error');
                }
                
            } catch (error) {
                console.error('Error:', error);
                showMessage('An error occurred. Please try again.', 'error');
            }
        });

                // Cleanup when page is closed
                window.onbeforeunload = () => {
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                    }
                };
            
            // Expose a namespaced init if needed
            window.regPage = window.regPage || {};
            window.regPage.init = function(){ regInitCamera(); };
            })();
        </script>

        <script>
            window.FACEATTEND_CONFIG = {{ app_config | tojson }};
        </script>
        <script src="{{ url_for('static', filename='js/script.js') }}"></script>
</body>
</html>